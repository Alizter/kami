<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta name="generator" content="pandoc" />
    <title>Kami: A Platform for High-Level Parametric Hardware Specification and its Modular Verification</title>

    <!-- Custom styles for this template -->
    <link href="cover.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Lato:100,300,400" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet">
  </head>

  <body>
    <div id="header">
      <h1 class="title">Kami: A Platform for High-Level Parametric Hardware Specification and its Modular Verification</h1>
      <h3 class="subtitle"><a href="http://icfp17.sigplan.org/track/icfp-2017-Artifacts">ICFP 2017 Artifact Evaluation</a></h3>
    </div>
    <div id="tabs">
      <ul>
	<li><a href="#before">Before getting started</a></li>
	<li><a href="#system">System requirements</a></li>
	<li><a href="#installation">Quick installation guide</a></li>
	<li><a href="#contents">Explore the contents</a></li>
	<li><a href="#instructions">Detailed instructions for compiling, extracting, and simulating Kami programs</a></li>
	<li><a href="#details">Technical details</a></li>
      </ul>
    </div>

    <hr />
    <h2 id="before">Before getting started</h2>
    <p class="introduction">Thanks for evaluating this artifact! This page
      describes the generic installation procedure for the Kami framework as
      well as how to explore our multiprocessor and memory implementation,
      which can run several <a href="https://riscv.org/">RISC-V</a> programs.
    </p>

    <h3>How to run the artifact</h3>
    <p>You should first choose whether to run the artifact on a virtual machine
      (VM) we provide or just with the source code. You should manually set up
      your environment (following <a href="#library">Library requirements</a>)
      if you choose the source tarball. The VM is already fully configured.
    </p>

    <h3>What to evaluate</h3>
    <p>The evaluation basically involves checking what we claim in our paper.
      It includes the following items:
    </p>
    <ul>
      <li>A Kami implementation of multiprocessor and memory</li>
      <li>A correctness proof for the implementation</li>
      <li>Bluespec code generation from the Kami implementation</li>
      <li>Simulation of the Bluespec code</li>
    </ul>
    <p>Note that we could not provide the FPGA-synthesis procedure from Bluespec
      programs, which is also claimed in our paper, because it requires an
      actual FPGA board.
    </p>

    <hr />
    <h2 id="system">System requirements</h2>
    <p>Below is the recommended system requirements to run the framework:</p>
    <ul>
      <li>8GB RAM: we checked that the framework doesn't compile with 6GB
	RAM. 8GB is required to avoid "out-of-memory" errors. Note that the
	requirement is based on single-core compilation. If you want to
	do <span class="code">make</span> using the <span class="code">-j</span>
	option, you will need even more RAM. For instance, 12GB is required for
	dual-core compilation.
      </li>
      <li>12GB storage: for stable installation, 12GB storage (or more)
	is required.
      </li>
    </ul>

    <hr />
    <h2 id="installation">Quick installation guide</h2>
    <p>If you are running on the virtual machine we provided, then you can just
      follow the below procedure for running Kami.
    </p>
    <ol>
      <li>Go to <span class="code">/home/Kami/kami/</span>, where the source
	code is extracted.
      </li>
      <li> Run <span class="code">source configure.sh</span>, to set
	some Bluespec-related environmental variables.
      </li>
      <li> Run <span class="code">make</span>. It is fine to increase the number
	of cores using the <span class="code">-j</span> option, but you will need
	enough RAM (more than 8GB) to avoid "out-of-memory" errors. The source code
	precompiled, but you will need to
	run <span class="code">make</span> again when you change the code.
      </li>
      <li> Run <span class="code">make</span>
	in <span class="code">./extraction/Ocaml/</span>. It will generate a
	pretty-printer <span class="code">Main.native</span>.
      </li>
      <li> Run <span class="code">./Main.native Proc.bsv</span>
	in <span class="code">./extraction/Ocaml/</span>. It will generate a
	Bluespec program <span class="code">Proc.bsv</span>.
      </li>
      <li> Copy <span class="code">Proc.bsv</span>
	to <span class="code">./extraction/BluespecFrontEnd/sim/</span>, and
	run <span class="code">make</span> in that directory. It will compile
        the Bluespec program and generate an
	executable <span class="code">ProcSim</span> that simulates the program.
	It will also generate Verilog files.
      </li>
      <li> Run <span class="code">ProcSim</span>
	in <span class="code">./extraction/BluespecFrontEnd/sim/</span> to check
	the simulation.
      </li>
    </ol>
    
    <hr />
    <h2 id="contents">Explore the contents</h2>
    <p>Here we explain the entire contents by directory.</p>
    <ul>
      <li><span class="code">lib</span>: Contains some fairly generic Coq code 
        for common types and data structures that
	we developed for Kami,
	such as bit-vectors, decidable finite maps with strings as keys, etc.
      </li>
      <li><span class="code">src</span>: Contains the source code for syntax,
	semantics, theorems/properties, and proof automation for Kami.
      </li>
      <li><span class="code">examples</span>: Contains the multiprocessor
	implementation, spec, and proof of correctness. Contains both the
	4-stage processor implementation and the coherent caches attached to a
	backing memory.
      </li>
      <li><span class="code">extraction</span>: Contains files needed to extract
	designs developed in Kami into Bluespec.
	<ul>
	  <li><span class="code">BluespecFrontEnd/sim</span>: Contains the files
	    to simulate Kami modules on the Bluespec simulator.
	  </li>
	  <li><span class="code">Ocaml</span>: Contains the files to
	    pretty-print the OCaml code extracted from Coq.
	  </li>
	</ul>
      </li>
    </ul>

    <hr />
    <h2 id="instructions">Detailed instructions for compiling, extracting, and simulating Kami programs</h2>

    <h3>Compilation</h3>

    <ul>
      <li> <span class="code">source configure.sh</span> exports several
	Bluespec-related variables and
	changes <span class="code">PATH</span>. You should set these variables
	properly by modifying the script.
      </li>
      <li>Run <span class="code">make</span> to fully compile library,
	framework, and example code including all related proofs. It takes
	around 8 hours with a single core, 6.5 hours with dual cores. A stack
	limit should be set to "unlimited" to compile everything, so we
	use <span class="code">ulimit -s unlimited</span>
	in <span class="code">Makefile</span>. Some operating systems, however,
	do not allow such stack limit manipulation. If you
	find <span class="code">ulimit</span> does not work, you should manually
	set the stack size properly depending on your operating system.
      </li>
      <li>Run <span class="code">make src</span> to compile just the library and
	framework. It takes under an hour with a single core. Note that it does
	not compile the examples.
      </li>
    </ul>

    <h3>Extraction</h3>

    <ul>
      <li>To extract OCaml ASTs from a target Kami program:
	run <span class="code">./extraction/Extraction.v</span>. It will
	generate <span class="code">./extraction/Ocaml/Target.ml (.mli)</span>.
      </li>
      <li>To generate Bluespec code from OCaml ASTs:
	<ol>
	  <li>Run <span class="code">make</span> in the
	    directory <span class="code">./extraction/Ocaml/</span>. It should
	    finish within a minute.
	  </li>
	  <li>Run <span class="code">./Main.native Proc.bsv</span> to generate
	  the Bluespec (.bsv) program.
	  </li>
	</ol>
      </li>
    </ul>

    <h3>Simulation</h3>

    <p>Once <span class="code">Proc.bsv</span> has been generated by 
      extraction, do the following to simulate the Bluespec program.
    </p>

    <ol>
      <li>Copy <span class="code">Proc.bsv</span>
	to <span class="code">./extraction/BluespecFrontEnd/sim/</span>.
      </li>
      <li>Copy <span class="code">HostSim_2cores.bsv__</span>
	or <span class="code">HostSim_4cores.bsv__</span>
	to <span class="code">HostSim.bsv</span>, which depends on how many
	cores are built in the processor.
      </li>
      <li>Run <span class="code">make</span> in the
	directory <span class="code">./extraction/BluespecFrontEnd/sim/</span>. It
	will generate an executable <span class="code">ProcSim</span> that
	simulates the program and Verilog files as well. It takes around 15
	minutes.
      </li>
      <li>Run <span class="code">ProcSim</span> to check the simulation.
      </li>
    </ol>

    <h3>One step further: to change/add the benchmark being compiled</h3>

    <ul>
      <li>Our multithreaded benchmarks can be run on 2 or 4 cores by modifying
	the program being executed in line 68
	in <span class="code">./extraction/Extraction.v</span>. For instance,
	replacing (IsaRv32PgmMatMulInit, IsaRv32PgmMatMulNormal1,
	IsaRv32PgmMatMulNormal2, IsaRv32PgmMatMulReport) in line 68 with
	(IsaRv32PgmBankerInit, IsaRv32PgmBankerWorker1, IsaRv32PgmBankerWorker2,
	IsaRv32PgmBankerWorker3) respectively will run the 4-core version of the
	Banker example.
      </li>
      <li>See the list of benchmarks (directly converted from C code), which are
	shown in <span class="code">./examples/IsaRv32PgmExt.v</span>. You
	should redo all the steps above to build and run the new Benchmark.
      </li>
      <li>To add a new benchmark, do the following steps in the directory
	<span class="code">./example/isa_rv32/</span>:
	<ol>
	  <li>Write the C code that you want to compile into Kami (one program
	    for each core).
	  </li>
	  <li>Compile the C code (say test.c) into an assembly code using the
	    RISC-V gcc compiler as follows (assuming risc-v GCC is in your path,
	    sometimes you will need <span class="code">-O1</span> to optimize
	    the risc-v assembly code since we currently restrict the number of
	    instructions in the program to be less than 256): <br />
	    <span class="code">
	      riscv32-unknown-elf-gcc [-O1] -nostartfiles -nodefaultlibs -nostdlib -static -S -T config.ld test.c
	    </span> <br />
	    <span class="code">
	      riscv32-unknown-elf-gcc [-O1] -nostartfiles -nodefaultlibs -nostdlib -static -s -T config.ld test.c
	    </span> <br />
	    <span class="code">
	      riscv32-unknown-elf-objdump -d a.out &gt; test.objdump
	    </span> <br />
	    <span class="code">
	      ./gen_kami_rv32_pgm.sh test.objdump IsaTest.v
	    </span>
	  </li>
	  <li>Now add <span class="code">IsaTest.v</span>
	    to <span class="code">./examples/IsaRv32PgmExt.v</span>. This adds a
	    new benchmark <span class="code">IsaTest.v</span>.
	  </li>
	  <li>Redo all the steps from the beginning to build and run the new
	    benchmark.
	  </li>
	</ol>
      </li>
    </ul>
    
    <hr />
    <h2 id="details">Technical details</h2>
    
    <h3 id="library">Library requirements</h3>
    <p>The following tools/libraries are necessary for compilation.
       The VM that we provided provides all of these dependencies.</p>
    <ul>
      <li><em>Coq 8.5</em> is required to define and verify Kami modules. We
      tested that Kami compiles with both <em>Coq 8.5pl2</em> and 
      <em>Coq 8.5pl3</em>.
      </li>
      <li><em>OCaml 4.02.3</em> and <em>Batteries Library for OCaml 2.5.2 (or
	higher)</em> are required to generate Bluespec programs from Kami
	programs.
      </li>
      <li><em>Bluespec compiler/simulator 2014.07.A</em> is required to run
	(simulate) Bluespec programs.  Unfortunately, Bluespec is closed-source,
        but our VM includes a specially licensed version for this artifact
        evaluation, and in general free licenses are available from
        <a href="http://bluespec.com/">Bluespec, Inc.</a> for academic use.
      </li>
      <li><em>32-bit RISC-V gcc compiler 6.1.0 (or higher)</em> is required to
	compile C code to run on our multiprocessor.
      </li>
    </ul>

    <h3 id="bluespec">Compilation/simulation by Bluespec</h3>
    <p>In the virtual machine, we provide a temporary license for the Bluespec
      compiler/simulator that expires on June 30, 2017.
    </p>
    <p>We thank Bluespec, Inc. for their kind support.</p>

    <br />

  </body>
</html>
